---
title: "Second Project"
output: html_document
date: "2022-11-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#Loading our libraries
library(tidyverse)
library(dplyr)
library(lubridate)
library(ggbeeswarm)
library(ggrepel)
```

```{r}
#Loading the referee data and creating a dataframe with game-level data
refs <- read_csv("~/Downloads/officials_2021-22.csv")

refs <- refs %>%
  mutate(date = mdy(date))

logs_2022 <- read_csv("http://dwillis.github.io/sports-data-files/wbb_game_logs_2022.csv")

refs_and_logs <- logs_2022 %>%
  inner_join(refs, by = c('date', 'ncaa_id')) %>%
  mutate(total_fouls = pf + opp_pf)
```

#Describe the data's scope to me - what time period or range of teams, etc, that it covers. What's included in the data and what isn't. Write the code to do this and then summarize it in text.

```{r}
#This was my first attempt at creating a dataframe of MD fouls
maryland_home_fouls <- refs %>%
  filter(home == 'Maryland') %>%
  group_by(home_fouls) %>%
  arrange(desc(home_fouls))

maryland_away_fouls <- refs %>%
  filter(visitor == 'Maryland') %>%
  group_by(visitor_fouls) %>%
  arrange(desc(visitor_fouls))
```

In this data, we have basic information about home and away teams, number of fouls (regular and technical) committed by each team and the names of the officials who were in charge of the game from last year's women's college basketball season. What we don't have is game outcome, which would be interesting to know to figure out how much fouls called either for or against a team impacts the game's outcome.

Here's the weird part, though. In these two dataframes, and in the entire refs dataframe as well, we have a ton of duplicate games. For example, in most of the Maryland_home_fouls, we have three identical records for each game. It looks like all the conference games have three records, and the non-conference games vary between one and two. The quirk is that each of those games, despite having identical stats, refs and game dates, have different game ids. Sometimes there are duplicate game ids and one distinct one. 

To fix this issue, I ran the distinct function to get rid of the duplicate game ids. However, we still have two records for every game. I'm not sure how to further condense those, but I'm making progress! Clearly, Maryland did not play 59 games last year.

#Next, I want to see that you've begun digging into your analysis, so that means writing code and summarizing the results of your explorations. The more detail you can provide, the better.

```{r}
#This is me doing a surface-level look at the referee data
refs %>%
  arrange(desc(home_fouls))

refs %>%
  arrange(desc(home_technicals))

refs %>%
  arrange(desc(visitor_fouls))

refs %>%
  arrange(desc(visitor_technicals))

crews <- refs %>%
  group_by(officials, home, visitor) %>%
  summarise(count = n()) %>%
  arrange(desc(count))
```

Alright, here, I was curious about which refs called the most common and technical fouls last season. Let's take a look at the top game for common fouls â€” Pfeiffer vs.	Hollins. In this game, a total of 66 fouls were committed, 35 for Pfeiffer and 31 against Hollins. Two Hollins players fouled out and three picked up four fouls. On the other side, while no Pfeiffer player fouled out, they had five players pick up four fouls. The weird part: Pfeiffer played 14 different players. What's also odd is that this was the first game of the season. There's some pretty weird stuff going on here.

If we look at the highest number of technical fouls, we get a game between Maryland Eastern Shore	and	Morgan State. MES got four techs to MSs five for a total of nine Ts! Here's the lede from the story written for the team website: "The University of Maryland Eastern Shore dug themselves an early hole on Monday night at home against Morgan State heading into the half down 35-21 in what was an extremely physical game and were never quite able to battle back." Two players were ejected in this game. 

I think this line of investigation is interesting because it can show us which teams had the most fouls on a large scale and which games were the chippiest on an individual scale. It might also be able to tell us a little bit about the refs who were in charge of officiating these games to see if certain refs/crews call more fouls or let teams play more.

#In particular, I want you to focus on your biggest question or problem that you need to solve for this analysis. Is the data you want incomplete or in need of cleaning? Are you struggling to figure out what the best question is, or how to start? Describe the issue and what you've tried to do so far to address it.

The crews dataframe generates a whole host of additional questions, but the main one is that there are tons of records without any information about who the referees were. I also played around with grouping by the officials and the two schools to see if there was anything there, but the data isn't great. Looks like this data needs to be cleaned.

My second biggest question is dealing with the officials column itself. In most cases, we have three refs per row, but some have two or one and some are empty. It might be beneficial to either alphabetize the columns so we can see how many times a crew worked together, or maybe we should separate them into distinct columns. I'm just not sure how this would work with multiple elements after the comma. Would I need to run two separates?

```{r}
#Creating dataframes that will be easier to work with than the original data.
unique_games <- refs_and_logs %>% 
  select(-ncaa_id, -game_id) %>% 
  distinct()

games_with_refs <- unique_games %>% 
  separate(officials, c('ref1', 'ref2', 'ref3'), sep=",", fill="right") %>%
  pivot_longer(cols = c('ref1', 'ref2', 'ref3'), values_to = 'ref') %>%
  mutate(ref = str_squish(ref)) %>%
  filter(!is.na(ref)) %>%
  filter(ref != '') %>%
  mutate(total_fouls = pf + opp_pf)

#Maryland specific data and refs  
md_refs <- games_with_refs %>%
  filter(team == 'Maryland')

md_refs_by_game <- md_refs %>% 
  group_by(ref) %>%
  summarise(games = n()) %>%
  arrange(desc(games))

md_refs_more_than_3_games <- md_refs_by_game %>%
  filter(games > 2)

#Refs dataframe with games and avg fouls (and then the top-25 referees by game) + bar chart graph
distinct_refs <- games_with_refs %>%
  group_by(ref) %>%
  summarise(total_fouls = sum(total_fouls), games = n()) %>%
  mutate(average_fouls = total_fouls/games) %>%
  arrange(desc(games))

top_25_refs_fouls_per_game <- distinct_refs %>%
  filter(games > 126)

ggplot() + 
  geom_bar(
    data=top_25_refs_fouls_per_game, 
    aes(x=reorder(ref, `average_fouls`), weight=`average_fouls`)) + 
  labs(
    title="Who Are The Most Whistle-Happy Officials?",
    subtitle = "There Are Some Referees Your Team Might Not Want To See On The Docket",
    x="Referee", 
    y="Average Fouls") + 
  theme_light() + 
  coord_flip()
```

#Run a regression - How realted are wins and fouls?
```{r}
#Running several models to see the relationship between fouls, wins and point-differential
fit <- lm(win ~ pf, data = logs_2022)
summary(fit)

newcorrelations <- logs_2022 %>% 
  mutate(differential = pts - opp_pts)

fit2 <- lm(differential ~ pf, data = newcorrelations)
summary(fit2)

wins_and_fouls <- logs_2022 %>%
  group_by(team) %>%
  summarise(total_wins = sum(win), avg_fouls = mean(pf), total_games = n()) %>%
  filter(total_games > 16)

fit3 <- lm(total_wins ~ avg_fouls, data = wins_and_fouls)
summary(fit3)

#Charting the relaionship of wins and avg fouls using a scatterplot
ggplot() + geom_point(data=wins_and_fouls, aes(x=avg_fouls, y=total_wins)) +
  geom_smooth(data=wins_and_fouls, aes(x=avg_fouls, y=total_wins), method="lm")
```

```{r}
#Creating more dataframes with information on individual refs and charting them
fouls_by_refs <- games_with_refs %>%
  group_by(ref) %>%
  summarise(avg_fouls = mean(total_fouls), games = n()) %>%
  filter(games > 10) %>%
  arrange(desc(avg_fouls))

top_avg_fouls_by_ref <- fouls_by_refs %>%
  filter(avg_fouls > 38.3)

#Looking at the relationship of fouls by refs and number of games officiated
ggplot() + geom_point(data=fouls_by_refs, aes(x=games, y=avg_fouls)) +
  geom_smooth(data=fouls_by_refs, aes(x=games, y=avg_fouls), method="lm") +
  geom_hline(yintercept=33.8) +
  labs(
    title="The More Games One Officiates, The Less Fouls One Calls", 
    x="Games", 
    y="Average Fouls")

ggplot() + geom_point(data=top_avg_fouls_by_ref, aes(x=games, y=avg_fouls)) +
  geom_smooth(data=top_avg_fouls_by_ref, aes(x=games, y=avg_fouls), method="lm") +
  geom_hline(yintercept=33.8) +
  labs(
    title="How Consistent Are The Most-Used Refs?", 
    x="Games", 
    y="Average Fouls")

ggplot() + 
  geom_bar(
    data=md_refs_more_than_3_games, 
    aes(x=reorder(ref, `games`), weight=`games`)) + 
  labs(
    title="Referees Who Officiate Maryland Women's Basketball Most", 
    x="Referee", 
    y="Games") + 
  theme_light() + 
  coord_flip()

all_refs_number_of_games <- dinstinct_refs %>%
  filter(count > 126)

ggplot() + 
  geom_bar(
    data=all_refs_number_of_games, 
    aes(x=reorder(ref, `count`), weight=`count`)) + 
  labs(
    title="Referees Who Officiate Women's Basketball Most", 
    x="Referee", 
    y="Games") + 
  theme_light() + 
  coord_flip()
```

```{r}
#Creating a dataframe with home and away foul information for the Big Ten with charts
fouls_by_month <- refs_and_logs %>%
  mutate(month = floor_date(date, unit="months")) %>%
  group_by(month) %>%
  summarise(monthly_total = sum(pf) + sum(opp_pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games) %>%
  filter(games > 25)

big_10 <- c('Nebraska', 'Northwestern', 'Iowa', 'Illinois', 'Ohio St.', 'Maryland', 'Minnesota', 'Rutgers', 'Michigan', 'Michigan St.', 'Wisconsin', 'Purdue', 'Penn St.', 'Indiana')

fouls_by_month_and_team <- refs_and_logs %>%
  mutate(month = floor_date(date, unit="months")) %>% 
  filter(home %in% big_10) %>%
  group_by(month, home_team_name) %>%
  summarise(monthly_total = sum(pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games)

fouls_by_month_and_team_visitor <- refs_and_logs %>%
  mutate(month = floor_date(date, unit="months")) %>%
  filter(away_team_name %in% big_10) %>%
  group_by(month, away_team_name) %>%
  summarise(monthly_total = sum(opp_pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games)

all_fouls_by_month_and_team <- refs_and_logs %>%
  group_by(month(date), home_team_name) %>%
  summarise(monthly_total = sum(pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games) %>%
  filter(games > 3)

all_fouls_by_month_and_team_visitor <- refs_and_logs %>%
  group_by(month(date), away_team_name) %>%
  summarise(monthly_total = sum(opp_pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games) %>%
  filter(games > 3) %>%
  arrange(desc(avg_fouls_per_month))
```

```{r}
#Maryland home and away fouls by month with charts
maryland_home_fouls_by_month <- fouls_by_month_and_team %>%
  filter(home_team_name == 'Maryland')

maryland_away_fouls_by_month <- fouls_by_month_and_team_visitor %>%
  filter(away_team_name == 'Maryland')

ggplot() + 
  geom_bar(
    data=maryland_home_fouls_by_month, 
    aes(x=month, weight=`avg_fouls_per_month`)) + 
  labs(
    title="Maryland Average Home Fouls Per Month", 
    x="Month", 
    y="Average Fouls") + 
  theme_light() +
  ylim(0, 35)

ggplot() + 
  geom_bar(
    data=maryland_away_fouls_by_month, 
    aes(x=month, weight=`avg_fouls_per_month`)) + 
  labs(
    title="Maryland Average Away Fouls Per Month", 
    x="Month", 
    y="Average Fouls") + 
  theme_light() +
  ylim(0, 35)

ggplot() + geom_bar(data=fouls_by_month_and_team, aes(x=month, weight=avg_fouls_per_month, fill=home_team_name)) + theme_minimal() + coord_polar()

ggplot() + 
  geom_hline(yintercept=16.3, color="green") + 
  geom_line(data=fouls_by_month_and_team, aes(x=month, y=avg_fouls_per_month, group=home_team_name)) + 
  scale_y_continuous(limits = c(10, 25)) + 
  facet_wrap(~home_team_name)

fouls_by_month_and_team %>% summarise(mean(avg_fouls_per_month))

ggplot() + 
  geom_hline(yintercept=16.5, color="red") + 
  geom_line(data=fouls_by_month_and_team_visitor, aes(x=month, y=avg_fouls_per_month, group=away_team_name)) + 
  scale_y_continuous(limits = c(10, 25)) + 
  facet_wrap(~away_team_name)

fouls_by_month_and_team_visitor %>% summarise(mean(avg_fouls_per_month))
```

```{r}
#Overall average fouls per month in WBB
ggplot() + 
  geom_bar(
    data=fouls_by_month, 
    aes(x=month, weight=`avg_fouls_per_month`)) + 
  labs(
    title="Average Fouls Per Month", 
    x="Month", 
    y="Average Fouls") + 
  theme_light() +
  ylim(0, 50)
```

```{r}
#Creating a dataframe with home and away foul information for the SEC with charts
sec <- c('Alabama', 'Arkansas', 'Auburn', 'LSU', 'Mississippi St.', 'Texas A&M', 'Ole Miss', 'Florida', 'Georgia', 'Kentucky', 'Missouri', 'Tennessee', 'Vanderbilt', 'South Carolina')

sec_fouls_by_month_and_team <- refs_and_logs %>%
  mutate(month = floor_date(date, unit="months")) %>% 
  filter(home_team_name %in% sec) %>%
  group_by(month, home_team_name) %>%
  summarise(monthly_total = sum(pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games) %>%
  filter(games > 1)

sec_fouls_by_month_and_team_visitor <- refs_and_logs %>%
  mutate(month = floor_date(date, unit="months")) %>%
  filter(away_team_name %in% sec) %>%
  group_by(month, away_team_name) %>%
  summarise(monthly_total = sum(opp_pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games)

ggplot() + 
  geom_hline(yintercept=17, color="green") + 
  geom_line(data=sec_fouls_by_month_and_team, aes(x=month, y=avg_fouls_per_month, group=home_team_name)) + 
  scale_y_continuous(limits = c(10, 25)) + 
  facet_wrap(~home_team_name)

sec_fouls_by_month_and_team %>% summarise(mean(avg_fouls_per_month))

ggplot() + 
  geom_hline(yintercept=16.5, color="red") + 
  geom_line(data=sec_fouls_by_month_and_team_visitor, aes(x=month, y=avg_fouls_per_month, group=away_team_name)) + 
  scale_y_continuous(limits = c(10, 25)) + 
  facet_wrap(~away_team_name)

sec_fouls_by_month_and_team_visitor %>% summarise(mean(avg_fouls_per_month))
```

```{r}
#Creating a dataframe with home and away foul information for the Big Twelve with charts
big_12 <- c('Baylor', 'Iowa St.', 'Kansas', 'Kansas St.', 'Oklahoma', 'Oklahoma St.', 'Texas Tech', 'West Virginia', 'TCU', 'Texas')

big_12_fouls_by_month_and_team <- refs_and_logs %>%
  mutate(month = floor_date(date, unit="months")) %>% 
  filter(home_team_name %in% big_12) %>%
  group_by(month, home_team_name) %>%
  summarise(monthly_total = sum(pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games)

big_12_fouls_by_month_and_team_visitor <- refs_and_logs %>%
  mutate(month = floor_date(date, unit="months")) %>%
  filter(away_team_name %in% big_12) %>%
  group_by(month, away_team_name) %>%
  summarise(monthly_total = sum(opp_pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games)

ggplot() + 
  geom_hline(yintercept=16.3, color="green") + 
  geom_line(data=big_12_fouls_by_month_and_team, aes(x=month, y=avg_fouls_per_month, group=home_team_name)) + 
  scale_y_continuous(limits = c(10, 25)) + 
  facet_wrap(~home_team_name)

ggplot() + 
  geom_hline(yintercept=16.5, color="red") + 
  geom_line(data=big_12_fouls_by_month_and_team_visitor, aes(x=month, y=avg_fouls_per_month, group=away_team_name)) + 
  scale_y_continuous(limits = c(10, 25)) + 
  facet_wrap(~away_team_name)
```

```{r}
#Creating a dataframe with home and away foul information for the Big East with charts
big_east <- c('Butler', 'UConn', 'Creighton', 'Seton Hall', 'DePaul', 'Marquette', 'Providence', 'Villanova', 'Georgetown', 'Xavier', "St. John's (NY)")

big_east_fouls_by_month_and_team <- refs_and_logs %>%
  mutate(month = floor_date(date, unit="months")) %>% 
  filter(home_team_name %in% big_east) %>%
  group_by(month, home_team_name) %>%
  summarise(monthly_total = sum(pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games)

big_east_fouls_by_month_and_team_visitor <- refs_and_logs %>%
  mutate(month = floor_date(date, unit="months")) %>%
  filter(away_team_name %in% big_east) %>%
  group_by(month, away_team_name) %>%
  summarise(monthly_total = sum(opp_pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games)

ggplot() + 
  geom_hline(yintercept=16.3, color="green") + 
  geom_line(data=big_east_fouls_by_month_and_team, aes(x=month, y=avg_fouls_per_month, group=home_team_name)) + 
  scale_y_continuous(limits = c(10, 25)) + 
  facet_wrap(~home_team_name)

big_east_fouls_by_month_and_team %>% summarise(mean(avg_fouls_per_month))

ggplot() + 
  geom_hline(yintercept=16.5, color="red") + 
  geom_line(data=big_east_fouls_by_month_and_team_visitor, aes(x=month, y=avg_fouls_per_month, group=away_team_name)) + 
  scale_y_continuous(limits = c(10, 25)) + 
  facet_wrap(~away_team_name)

big_east_fouls_by_month_and_team_visitor %>% summarise(mean(avg_fouls_per_month))
```

```{r}
#Creating a dataframe with home and away foul information for the Pac 12 with charts
pac_12 <- c('Arizona', 'Arizona St.', 'UCLA', 'Southern California', 'Oregon St.', 'Oregon', 'Washington St.', 'Washington', 'Colorado', 'Utah', 'Stanford')

pac_12_fouls_by_month_and_team <- refs_and_logs %>%
  mutate(month = floor_date(date, unit="months")) %>% 
  filter(home_team_name %in% pac_12) %>%
  group_by(month, home_team_name) %>%
  summarise(monthly_total = sum(pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games)

pac_12_fouls_by_month_and_team_visitor <- refs_and_logs %>%
  mutate(month = floor_date(date, unit="months")) %>%
  filter(away_team_name %in% pac_12) %>%
  group_by(month, away_team_name) %>%
  summarise(monthly_total = sum(opp_pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games)

ggplot() + 
  geom_hline(yintercept=16.3, color="green") + 
  geom_line(data=pac_12_fouls_by_month_and_team, aes(x=month, y=avg_fouls_per_month, group=home_team_name)) + 
  scale_y_continuous(limits = c(10, 25)) + 
  facet_wrap(~home_team_name)

ggplot() + 
  geom_hline(yintercept=16.5, color="red") + 
  geom_line(data=pac_12_fouls_by_month_and_team_visitor, aes(x=month, y=avg_fouls_per_month, group=away_team_name)) + 
  scale_y_continuous(limits = c(10, 25)) + 
  facet_wrap(~away_team_name)
```

```{r}
#Creating a dataframe with home and away foul information for the ACC with charts
acc <- c('Boston College', 'Boston U.', 'Clemson', 'Duke', 'Florida St.', 'Syracuse', 'Louisville', "Miami (FL)", 'NC State', 'Virginia Tech', 'North Carolina', 'Pittsburgh', 'Virginia', 'Wake Forest', 'Georgia Tech')

acc_fouls_by_month_and_team <- refs_and_logs %>%
  mutate(month = floor_date(date, unit="months")) %>% 
  filter(home_team_name %in% acc) %>%
  group_by(month, home_team_name) %>%
  summarise(monthly_total = sum(pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games)

acc_fouls_by_month_and_team_visitor <- refs_and_logs %>%
  mutate(month = floor_date(date, unit="months")) %>%
  filter(away_team_name %in% acc) %>%
  group_by(month, away_team_name) %>%
  summarise(monthly_total = sum(opp_pf), games = n()) %>%
  mutate(avg_fouls_per_month = monthly_total/games)

ggplot() + 
  geom_hline(yintercept=16.3, color="green") + 
  geom_line(data=acc_fouls_by_month_and_team, aes(x=month, y=avg_fouls_per_month, group=home_team_name)) + 
  scale_y_continuous(limits = c(10, 25)) + 
  facet_wrap(~home_team_name)

ggplot() + 
  geom_hline(yintercept=16.5, color="red") + 
  geom_line(data=acc_fouls_by_month_and_team_visitor, aes(x=month, y=avg_fouls_per_month, group=away_team_name)) + 
  scale_y_continuous(limits = c(10, 25)) + 
  facet_wrap(~away_team_name)
```

#Here is the link to my in-class presentation

https://github.com/iadecker/jour479x_fall_2022/blob/main/assignments/second_proj.prez.Rmd
